Spy=Class.create({spyInterval:10,animateInterval:3,updater:false,animater:false,timestamp:false,activeStory:false,loadingStory:false,toggleText:false,storyLimit:50,stories:[],img_dir:(window.parent.document.location.host.match(/www\.yigg\.de$/)?window.parent.document.location.protocol+"//yigg.de/":"")+"images/",ajax_img:"ajaxindicator.gif",cancel_img:"cancel.png",startText:"Fortsetzen",stopText:"Anhalten",initialize:function(){if(true===$("NodeList").hasClassName("twit")){this.storyLimit=4}if(!NinjaCommander.spy){this.startUpdater();NinjaCommander.spy=true}this.setupStories();Event.observe(document,"keypress",function(a){this.keyPressHandler(a)}.bind(this));this.toggleText=$("toggleAnimation");this.toggleText.href="javascript:void(0);";this.toggleText.innerHTML=this.stopText;Event.observe(this.toggleText,"click",function(b){var a=b.element();if(a.stopped===true){a.stopped=false;this.stopAnimator();this.stopUpdater();this.startAnimator();this.startUpdater();a.innerHTML=this.stopText}else{a.stopped=true;a.innerHTML=this.startText;this.stopAnimator();this.stopUpdater()}}.bind(this))},keyPressHandler:function(b){var a=b.which||b.keyCode;if(a===Event.KEY_ESC){this.toggleText.stopped=true;this.toggleText.innerHTML=this.startText;this.stopAnimator();this.stopUpdater()}},setupStories:function(){this.stories=[];$$("#NodeList li.spyNode").each(function(a){if(this.stories.size()===0){this.timestamp=a.down(".node").id}this.stories.push(a);this.prepareNode(a)}.bind(this))},preUpdate:function(a){if(this.updater){this.updater.stop()}if(this.activeStory){this.reanimate();this.activeStory=false}},postUpdate:function(){this.setupStories()},prepareNode:function(b){var a=b.down("a.storylink");if(undefined!==a&&!a.storylink){a.storylink=a.href;a.href="javascript:void(0);";a.node=b;this.openSpyStory.bindAsEventListener(this);Event.observe(a,"click",function(d){if(Effect.Queues.get("showstory").size()===0){var c=d.element();if(!this.loadingStory){this.loadingStory=true;this.openSpyStory(c.storylink,c.node)}}else{return false}}.bind(this))}},startUpdater:function(){this.stopUpdater();this.startAnimator();this.updater=new PeriodicalExecuter(function(a){this.fetchNewNodes()}.bind(this),this.spyInterval)},stopUpdater:function(){if(this.updater){this.updater.stop();this.stopAnimator()}},startAnimator:function(){this.stopAnimator();this.animator=new PeriodicalExecuter(function(a){if(this.activeStory===false){var c;var b=$$("#NodeList li.new");if(b.size()>=0&&Effect.Queues.get("cyclestories").size()<1){while(b.size()>0&&Effect.Queues.get("cyclestories").size()===0&&this.activeStory===false){c=(true===b.last().next().hasClassName("odd"))?b.pop():b.pop().addClassName("odd");this.stories.unshift(c);this.animateNode(c)}}}}.bind(this),this.animateInterval)},stopAnimator:function(){if(this.animator){this.animator.stop()}},openSpyStory:function(a,b){this.stopUpdater();this.fetchStory(a,this.createStoryNode(b))},closeSpyStory:function(){this.reanimate();this.activeStory=false;if(this.spyInterval>10){this.spyInterval=10}this.startUpdater()},createStoryNode:function(b){var a=b.down(".story");if(!a){a=new Element("div",{"class":"story",style:"display:none;"});b.appendChild(a)}a.update("");return a},fetchNewNodes:function(){if(($$("#NodeList li.new").size()<5)&&(this.loadingStory===false)){if(!this.ajaxIndicator){this.ajaxIndicator=new Element("img",{src:this.img_dir+this.ajax_img,alt:"laden",id:"ajaxIndicator"});this.toggleText.parentNode.insert(this.ajaxIndicator,{position:top})}this.ajaxIndicator.show();if(!this.coms){this.coms=new NinjaComs()}this.coms.request("spy",$("pageFilter").action+"/latestNodes",$H({timestamp:this.timestamp}).merge($("pageFilter").serialize({hash:true})),"POST",function(b,a){this.processNewNodes(b,a);this.ajaxIndicator.hide()}.bind(this),true)}},processNewNodes:function(d,c){if(d.status!=304&&d.status==200){var b=$("NodeList");var a=d.responseText;b.insert({top:a});b.select("li.new").each(function(e){this.prepareNode(e)}.bind(this));this.timestamp=b.down(".node").id;if(this.spyInterval>10){this.spyInterval=10;this.startUpdater()}}else{if(d.status==304){this.spyInterval=this.spyInterval+(this.spyInterval*0.2);this.startUpdater()}}},fetchStory:function(a,b){if(this.activeStory!==false&&b!=this.activeStory){this.reanimate()}if(!this.coms){this.coms=new NinjaComs()}this.activeStory=b;this.coms.updater("spy",a,b,{},"get",function(c){this.animate();this.loadingStory=false}.bind(this))},animate:function(){var b=new Element("a",{"class":"closelink",title:"Schießen"}).update(new Element("img",{src:this.img_dir+this.cancel_img,alt:"Schließen"}));Event.observe(b,"click",function(c){if(Effect.Queues.get("showstory").size()===0){this.closeSpyStory();Event.stop(c)}}.bind(this));this.activeStory.appendChild(b);var a=new Effect.Parallel([new Effect.BlindUp(this.activeStory.parentNode.down(".node"),{sync:true}),new Effect.BlindDown(this.activeStory,{sync:true}),new Effect.Appear(b,{sync:true})],{queue:{position:"end",scope:"showstory",limit:2}});NinjaCommander.initialize()},reanimate:function(){var a=new Effect.Parallel([new Effect.BlindUp(this.activeStory,{sync:true,afterFinishInternal:function(b){$(b.element).remove()}}),new Effect.BlindDown(this.activeStory.parentNode.down(".node"),{sync:true})],{queue:{position:"front",scope:"showstory",limit:2}})},animateNode:function(a){var c=a.down(".node");c.addClassName("animating");a.addClassName("animating");c.removeClassName("new");a.removeClassName("new");var d=this.stories.pop().addClassName("old");var b=new Effect.Parallel([new Effect.BlindDown(a,{sync:true}),new Effect.BlindDown(a.down(".node"),{sync:true}),new Effect.BlindUp(d,{sync:true}),new Effect.BlindUp(d.down(".node"),{sync:true})],{queue:{position:"end",scope:"cyclestories",limit:1},afterFinish:function(g){var f=g.effects[0].element;$(f).removeClassName("animating");var e=g.effects[1].element;$(e).removeClassName("animating");var h=g.effects[2].element;h.remove()}})},reanimateNode:function(a){var b=new Effect.Parallel([new Effect.BlindUp(a,{sync:true}),new Effect.BlindUp(a.down(".node"),{sync:true})],{queue:{position:"back",scope:"deletestories",limit:2}})}});document.fire("Spy:loaded",{updater:new Spy()});